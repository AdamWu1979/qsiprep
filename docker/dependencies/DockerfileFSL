## Get FSL
FROM nvidia/cuda:9.1-runtime-ubuntu16.04

RUN apt-get update

ENV FSLDIR="/opt/fsl-6.0.3" \
    PATH="/opt/fsl-6.0.3/bin:$PATH"
RUN apt-get install curl  \
    && echo "Downloading FSL ..." \
    && mkdir -p /opt/fsl-6.0.3 \
    && curl -fsSL --retry 5 https://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-6.0.3-centos6_64.tar.gz \
    | tar -xz -C /opt/fsl-6.0.3 --strip-components 1 \
    --exclude='fsl/doc' \
    --exclude='fsl/data/atlases' \
    --exclude='fsl/data/possum' \
    --exclude='fsl/data/mist' \
    --exclude='fsl/src' \
    --exclude='fsl/extras/src' \
    --exclude='fsl/bin/fslview*' \
    --exclude='fsl/bin/FSLeyes' \
    && echo "Installing FSL conda environment ..." \
    && sed -i -e "/fsleyes/d" -e "/wxpython/d" \
       ${FSLDIR}/etc/fslconf/fslpython_environment.yml \
    && bash /opt/fsl-6.0.3/etc/fslconf/fslpython_install.sh -f /opt/fsl-6.0.3

RUN find ${FSLDIR}/fslpython/envs/fslpython/lib/python3.7/site-packages/ -type d -name "tests"  -print0 | xargs -0 rm -r \
    && ${FSLDIR}/fslpython/bin/conda clean --all \
    && cd ${FSLDIR}/bin \
    && rm -rf \
        aff2rigid \
        AnatomicalAverage \
        asl_calib \
        asl_file \
        asl_gui \
        asl_mfree \
        asl_reg \
        atlasq \
        autoaq \
        avw2fsl \
        Bet \
        basil \
        basil_var \
        baycest \
        bedpost \
        bedpostx \
        bedpostx_datacheck \
        bedpostx_gpu \
        bedpostx_postproc_gpu.sh \
        bedpostx_postproc.sh \
        bedpostx_preproc.sh \
        bedpostx_single_slice.sh \
        betsurf \
        bianca \
        bianca_cluster_stats \
        bianca_overlap_measures \
        calc_grad_perc_dev \
        ccops \
        checkFEAT \
        cluster \
        cluster2html \
        concat_bvars \
        contrast_mgr \
        convertwarp \
        create_lut \
        cutoffcalc \
        design_ttest2 \
        distancemap \
        drawmesh \
        dtifit \
        dtigen \
        dual_regression \
        easythresh \
        epi_reg \
        estnoise \
        extractfidparams \
        extracttxt \
        Fast \
        fabber \
        fabber_asl \
        fabber_cest \
        fabber_dce \
        fabber_dsc \
        fabber_dualecho \
        fabber_dwi \
        fabber_qbold \
        fabber_t1 \
        fabber_var \
        fdr \
        Fdt \
        feat \
        Feat \
        feat_gm_prepare \
        feat_model \
        featquery \
        Featquery \
        featregapply \
        film_cifti \
        film_gls \
        filmbabe \
        filmbabescript \
        find_the_biggest \
        flameo \
        Flirt \
        fnirt \
        fnirtfileutils \
        fsl \
        fsl_anat \
        fsl_boxplot \
        fsl_deface \
        fsl_ents \
        fsl_gen_3D \
        fsl_glm \
        fsl_gui \
        fsl_histogram \
        fsl_motion_outliers \
        fsl_mvlm \
        fsl_prepare_fieldmap \
        Fsl_prepare_fieldmap \
        fsl_reg \
        fsl_regfilt \
        fsl_sbca \
        fsl_schurprod \
        fsl_sub \
        fsl_tsplot \
        fsl2ascii \
        fsladd \
        fslanimate \
        fslascii2img \
        fslcc \
        fslchpixdim \
        fslcpgeom \
        fslcreatehd \
        fsledithd \
        fslerrorreport \
        fslfft \
        fslFixText \
        fslinterleave \
        fslipython \
        fslmodhd \
        fslpspec \
        fslpython \
        fslpythonw \
        fslselectvols \
        fslsmoothfill \
        fslsurfacemaths \
        fslswapdim_exe \
        fsltclsh \
        fslvbm_1_bet \
        fslvbm_2_template \
        fslvbm_3_proc \
        ftoz \
        funpack \
        funpack_demo \
        generate_b0 \
        generate_b0calc \
        generate_brain \
        generateConfounds \
        Glm \
        gps \
        halfcosbasis \
        hist2prob \
        img2imgcoord \
        img2stdcoord \
        InvertXFM \
        invfeatreg \
        invwarp \
        invwarp_exe \
        label2surf \
        lesion_filling \
        mainfeatreg \
        make_bianca_mask \
        make_dyadic_vectors \
        Make_flobs \
        maskdyads \
        match_smoothing \
        mccutup \
        mean \
        melodic \
        Melodic \
        merge_parts_gpu \
        midtrans \
        mist \
        mist_1_train \
        mist_2_fit \
        mist_display \
        mist_FA_reg \
        mist_mesh_utils \
        mm \
        morph_kernel \
        mp_diffpow.sh \
        mvntool \
        new_invwarp \
        Nudge \
        old_betall \
        overlay \
        oxford_asl \
        pairreg \
        perfusion_subtract \
        pngappend \
        Pnm \
        pnm_evs \
        pnm_stage1 \
        pointflirt \
        popp \
        possum \
        Possum \
        possum_interpmot.py \
        possum_matrix \
        possum_plot.py \
        possum_sum \
        possumX \
        possumX_postproc.sh \
        prewhiten \
        probtrack \
        probtrackx \
        probtrackx2 \
        probtrackx2_gpu \
        proj_thresh \
        ptoz \
        pulse \
        pvmfit \
        pyfeeds \
        qboot \
        qboot_parallel \
        qboot_postproc.sh \
        qboot_preproc.sh \
        quasil \
        randomise \
        randomise_parallel \
        renderhighres \
        Renderhighres \
        Renderstats \
        rmsdiff \
        run_first \
        run_first_all \
        run_mesh_utils \
        Runtcl \
        select_dwi_vols \
        selfintersection \
        setFEAT \
        setup_masks \
        siena \
        siena_cal \
        siena_diff \
        siena_flirt \
        siena_flow2std \
        sienax \
        sigloss \
        signal2image \
        sliceanimate \
        slicer \
        slices \
        slices_summary \
        slicesdir \
        slicesmask \
        slicetimer \
        smoothest \
        spharm_rm \
        standard_space_roi \
        std2imgcoord \
        surf_proj \
        surf2surf \
        surf2volume \
        surface_fdr \
        surfmaths \
        susan \
        Susan \
        swap_subjectwise \
        swap_voxelwise \
        swe \
        systemnoise \
        tbss_1_preproc \
        tbss_2_reg \
        tbss_3_postreg \
        tbss_4_prestats \
        tbss_deproject \
        tbss_fill \
        tbss_non_FA \
        tbss_skeleton \
        tbss_sym \
        tbss_x \
        tcalc \
        Text2Vest \
        tmpnam \
        toast \
        tsplot \
        ttologp \
        ttoz \
        unconfound \
        updatefeatreg \
        vecreg \
        verbena \
        Vest2Text \
        viena_createpng \
        viena_quant \
        whirlgif \
        wpng \
        xfibres \
        xfibres_gpu \
        xtract \
        xtract_viewer \
        zeropad \
        ztop \
    && cd ${FSLDIR}/lib \
    && rm -f $(ls | grep -iv gfortran | grep -iv openblas) \
    && cd ${FSLDIR}/fslpython/envs/fslpython/lib \
    && rm -rf libvtk* \
        libvorbis* \
        libxcb* \
        libgst* \
        libfreetype* \
        libQt5* \
        *tk* \
        libmkl* \
        *tcl* \
        *tdbc* \
    && cd ${FSLDIR}/fslpython/envs/fslpython/bin \
    && rm -rf \
        pandoc \
        pandoc-citeproc \
        qmake \
        qgltf \
        qwebengine_convert_dict \
        sqlite3 \
        assistant \
        linguist \
        qdoc \
        moc \
        rcc \
        openssl \
        zstd \
        qmlcachegen \
        lupdate \
        uic \
        vtkWrapPython-8.2 \
        sip \
        designer \
        vtkWrapJava-8.2 \
        vtkParseJava-8.2 \
        lrelease \
        h5diff \
        curl \
        qscxmlc \
        ncgen \
        h5dump \
        h5repack \
        qmlimportscanner \
        lz4 \
        qdbuscpp2xml \
        h5import \
        lconvert \
        h5ls \
        h5perf_serial \
        qmllint \
        gst-inspect-1.0 \
        h5stat \
        genrb \
        hdp \
        qhelpconverter \
        h5watch \
        gif2h5 \
        h5format_convert \
        gst-play-1.0 \
        h5copy \
        h5jam \
        h5clear \
        h5unjam \
        h5mkgrp \
        h52gif \
        qmlprofiler \
        tiffcrop \
        qdbusviewer \
        bunzip2 \
        bzcat \
        bzip2 \
        kadmin \
        ncdump \
        gio \
        qmlplugindump \
        gst-launch-1.0 \
        xz \
        ncgen3 \
        xmllint \
        qmleasing \
        qlalr \
        tic \
        hrepack \
        tiff2pdf \
        pcretest \
        gst-discoverer-1.0 \
        gst-stats-1.0 \
        hdiff \
        hdfed \
        qmlmin \
        h4_ncgen \
        ksu \
        nccopy \
        makeconv \
        tiff2ps \
        glib-compile-schemas \
        gdbus \
        infocmp \
        qdbusxml2cpp \
        pngfix \
        pcregrep \
        glib-compile-resources \
        hdfimport \
        gst-device-monitor-1.0 \
        tiffcp \
        qtdiag \
        qcollectiongenerator \
        qml \
        pkgdata \
        pixeltool \
        xmlpatterns \
        syncqt.pl \
        qmlscene \
        qdbus \
        ktutil \
        kinit \
        qtattributionsscanner \
        gst-typefind-1.0 \
        jpegtran \
        xmlwf \
        glib-genmarshal \
        xsltproc \
        klist \
        cjpeg \
        gsettings \
        gtester \
        dbus-send \
        dbus-monitor \
        canbusutil \
        gss-client \
        dbus-test-tool \
        djpeg \
        dbus-launch \
        fax2ps \
        tiffdump \
        h4_ncdump \
        derb \
        raw2tiff \
        gendict \
        tset \
        gencnval \
        tiffinfo \
        kvno \
        xmlcatalog \
        sqlite3_analyzer \
        tiff2bw \
        vshow \
        tiffmedian \
        tiff2rgba \
        glib-mkenums \
        gif2hdf \
        h5debug \
        gapplication \
        fax2tiff \
        uuclient \
        fc-cache \
        pal2rgb \
        tiffcmp \
        gresource \
        hdfls \
        ppm2tiff \
        sim_client \
        sclient \
        kpasswd \
        vmake \
        tiffdither \
        gio-querymodules \
        tiffsplit \
        tiffset \
        qhelpgenerator \
        qtplugininfo \
        qtpaths \
        tput \
        h5repart \
        toe \
        icu-config \
        genbrk \
        hdf2gif \
        dbus-update-activation-environment \
        hdfpack \
        fc-cat \
        bzip2recover \
        kdestroy \
        dbus-cleanup-sockets \
        lzmadec \
        xzdec \
        fc-match \
        dbus-run-session \
        wish8.6 \
        vtkpython \
        tclsh8.6 \
        kswitch \
        fc-validate \
        hdfcomp \
        gobject-query \
        hdftor8 \
        dbus-uuidgen \
        vtkWrapPythonInit-8.2 \
        hdf2jpeg \
        gio-launch-desktop \
        hdf24to8 \
        curve_keygen \
        png-fix-itxt \
        gtester-report \
        gencfu \
        lzmainfo \
        icuinfo \
        fc-scan \
        fc-list \
        wrjpgcom \
        fc-pattern \
        rdjpgcom \
        jpeg2hdf \
        fc-query \
        fc-conflist \
        hdf8to24 \
        hdfunpac \
        r8tohdf \
        ristosds \
        hdftopal \
        paltohdf \
        clear \
        tabs \
        h5cc \
        h5c++ \
        h5fc \
        xmlpatternsvalidator \
        curl-config \
        nc-config \
        h4cc \
        krb5-config \
        xzdiff \
        fixqt4headers.pl \
        qmltestrunner \
        ncursesw6-config \
        c_rehash \
        h5redeploy \
        xzgrep \
        glib-gettextize \
        freetype-config \
        prov-convert \
        prov-compare \
        h4redeploy \
        python3.7m-config \
        eddy_quad \
        xslt-config \
        pcre-config \
        xml2-config.bak \
        libpng16-config \
        eddy_squad \
        xml2-config \
        xzmore \
        bzdiff \
        gdbus-codegen \
        bzgrep \
        k5srvutil \
        nidmfsl \
        aws_zsh_completer.sh \
        xzless \
        rst2odt_prepstyles.py \
        jp.py \
        nidm_mkda_convert \
        aws.cmd \
        bzmore \
        nidmreader \
        rst2html5.py \
        aws_completer \
        rst2xetex.py \
        compile_et \
        aws \
        rst2latex.py \
        rst2odt.py \
        f2py \
        rst2html4.py \
        rstpep2html.py \
        rst2s5.py \
        rst2xml.py \
        rst2pseudoxml.py \
        rst2man.py \
        rst2html.py \
        nidmresults \
        pyvenv-3.7 \
        flake8 \
        jupyter-kernelspec \
        jupyter-trust \
        imageio_download_bin \
        imageio_remove_bin \
        pyrsa-priv2pub \
        jupyter-bundlerextension \
        iptest \
        iptest3 \
        easy_install \
        pyrsa-decrypt-bigfile \
        pyrsa-encrypt-bigfile \
        fsl_convert_x5 \
        parrec2nii \
        fsl_apply_x5 \
        ipython \
        ipython3 \
        jupyter-serverextension \
        jupyter-troubleshoot \
        nib-tck2trk \
        nib-trk2tck \
        rdfgraphisomorphism \
        jupyter-kernel \
        jupyter-qtconsole \
        pyreverse \
        ptrepack \
        fsl_ents \
        funpack_demo \
        jupyter-nbconvert \
        pip \
        jupyter-console \
        jupyter-nbextension \
        jupyter-run \
        pt2to3 \
        ptdump \
        pttree \
        skivi \
        epylint \
        imglob \
        jupyter \
        jupyter-migrate \
        jupyter-notebook \
        symilar \
        pasteurize \
        pygmentize \
        pylint \
        rdfs2dot \
        csv2rdf \
        futurize \
        rdf2dot \
        rdfpipe \
        pyrsa-decrypt \
        pyrsa-encrypt \
        funpack \
        pyfeeds \
        pycodestyle \
        pyrsa-keygen \
        pyrsa-verify \
        pyflakes \
        isort \
        pyrsa-sign \
        wheel \
        qt.conf \
        aws_bash_completer \
        2to3-3.7 \
        idle3.7 \
        pydoc3.7 \
        pylupdate5 \
        pyrcc5 \
        pyuic5 \
        libpng-config \
        2to3 \
        pydoc \
        pydoc3 \
        tclsh \
        idle3 \
        wish \
  && rm -rf \
        ${FSLDIR}/data/standard/*2mm* \
        ${FSLDIR}/data/standard/FSL_HCP* \
        ${FSLDIR}/data/standard/*_FA* \
        ${FSLDIR}/data/standard/bianca \
        ${FSLDIR}/data/standard/LowerCingulum_1mm.nii.gz \
        ${FSLDIR}/data/standard/MNI152_T1_0.5mm.nii.gz
